<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Continuous Location Tracker</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      margin: 0; 
      padding: 1rem; 
      background: #f5f5f5;
      min-height: 100vh;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status {
      padding: 0.5rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    .status.warning { background: #fff3cd; color: #856404; }
    .location-data {
      font-family: monospace;
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      border-left: 3px solid #007bff;
      max-height: 300px;
      overflow-y: auto;
    }
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    .btn:hover { background: #0056b3; }
    .btn:disabled { background: #6c757d; cursor: not-allowed; }
    .btn.danger { background: #dc3545; }
    .btn.danger:hover { background: #c82333; }
    .btn.success { background: #28a745; }
    .btn.success:hover { background: #218838; }
    .tracking-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .tracking-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #dc3545;
      animation: pulse 2s infinite;
    }
    .tracking-indicator.active {
      background: #28a745;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Continuous Location Tracker</h2>
    
    <div class="tracking-status">
      <div id="trackingIndicator" class="tracking-indicator"></div>
      <span id="trackingStatus">Background tracking: Inactive</span>
    </div>
    
    <div id="status" class="status info">Initializing...</div>
    <div id="location" class="location-data">No location data available</div>
    
    <div>
      <button id="startTracking" class="btn success">Start Background Tracking</button>
      <button id="stopTracking" class="btn danger">Stop Background Tracking</button>
      <button id="getLocation" class="btn">Get Current Location</button>
      <button id="viewStored" class="btn">View Stored Data</button>
      <button id="clearData" class="btn">Clear Data</button>
    </div>
  </div>

  <script>
    const status = document.getElementById('status');
    const locationDisplay = document.getElementById('location');
    const trackingIndicator = document.getElementById('trackingIndicator');
    const trackingStatus = document.getElementById('trackingStatus');
    const startTrackingBtn = document.getElementById('startTracking');
    const stopTrackingBtn = document.getElementById('stopTracking');
    const getLocationBtn = document.getElementById('getLocation');
    const viewStoredBtn = document.getElementById('viewStored');
    const clearDataBtn = document.getElementById('clearData');

    let serviceWorker;
    let isBackgroundTracking = false;

    // Register Service Worker
    async function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('/sw.js');
          console.log('Service Worker registered:', registration);
          
          serviceWorker = registration.active || registration.waiting || registration.installing;
          
          // Listen for messages from Service Worker
          navigator.serviceWorker.addEventListener('message', (event) => {
            const { type, data } = event.data;
            
            switch (type) {
              case 'location-updated':
                updateLocationDisplay(data);
                updateStatus(`Background location updated at ${new Date(data.timestamp).toLocaleTimeString()}`, 'success');
                break;
            }
          });
          
          updateStatus('Service Worker registered successfully', 'success');
        } catch (error) {
          console.error('Service Worker registration failed:', error);
          updateStatus('Service Worker registration failed', 'error');
        }
      } else {
        updateStatus('Service Worker not supported', 'error');
      }
    }

    function updateStatus(message, type = 'info') {
      status.textContent = message;
      status.className = `status ${type}`;
    }

    function updateTrackingStatus(active) {
      isBackgroundTracking = active;
      trackingIndicator.classList.toggle('active', active);
      trackingStatus.textContent = `Background tracking: ${active ? 'Active' : 'Inactive'}`;
      startTrackingBtn.disabled = active;
      stopTrackingBtn.disabled = !active;
    }

    function updateLocationDisplay(locationData) {
      const timestamp = new Date(locationData.timestamp).toLocaleString();
      locationDisplay.innerHTML = `
        <strong>Latest Location:</strong><br>
        Latitude: ${locationData.latitude.toFixed(6)}<br>
        Longitude: ${locationData.longitude.toFixed(6)}<br>
        Accuracy: ${locationData.accuracy ? locationData.accuracy.toFixed(2) + 'm' : 'N/A'}<br>
        Time: ${timestamp}
      `;
    }

    async function startBackgroundTracking() {
      if (serviceWorker) {
        serviceWorker.postMessage({ type: 'START_BACKGROUND_TRACKING' });
        updateTrackingStatus(true);
        updateStatus('Background location tracking started', 'success');
      } else {
        updateStatus('Service Worker not available', 'error');
      }
    }

    async function stopBackgroundTracking() {
      if (serviceWorker) {
        serviceWorker.postMessage({ type: 'STOP_BACKGROUND_TRACKING' });
        updateTrackingStatus(false);
        updateStatus('Background location tracking stopped', 'warning');
      } else {
        updateStatus('Service Worker not available', 'error');
      }
    }

    function getCurrentLocation() {
      if (!navigator.geolocation) {
        updateStatus('Geolocation not supported by your browser.', 'error');
        return;
      }

      updateStatus('Getting location...', 'info');
      getLocationBtn.disabled = true;

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude, accuracy } = position.coords;
          const timestamp = new Date(position.timestamp).toLocaleTimeString();
          
          const locationData = {
            latitude,
            longitude,
            accuracy,
            timestamp: position.timestamp,
            id: Date.now().toString()
          };
          
          updateLocationDisplay(locationData);
          updateStatus(`Location updated at ${timestamp}`, 'success');
          getLocationBtn.disabled = false;
        },
        (error) => {
          updateStatus(`Error: ${error.message}`, 'error');
          getLocationBtn.disabled = false;
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000 // 5 minutes
        }
      );
    }

    async function viewStoredData() {
      if (serviceWorker) {
        try {
          const messageChannel = new MessageChannel();
          
          messageChannel.port1.onmessage = (event) => {
            const { type, data } = event.data;
            if (type === 'STORED_LOCATIONS') {
              displayStoredLocations(data);
            }
          };
          
          serviceWorker.postMessage({ type: 'GET_STORED_LOCATIONS' }, [messageChannel.port2]);
        } catch (error) {
          console.error('Failed to get stored locations:', error);
          updateStatus('Failed to retrieve stored locations', 'error');
        }
      } else {
        updateStatus('Service Worker not available', 'error');
      }
    }

    function displayStoredLocations(locations) {
      if (locations.length === 0) {
        updateStatus('No stored location data found.', 'info');
        locationDisplay.textContent = 'No data available';
        return;
      }

      updateStatus(`Found ${locations.length} stored location(s)`, 'success');
      
      const dataHtml = locations.map((data, index) => `
        <div style="margin-bottom: 1rem; padding: 0.5rem; background: white; border-radius: 4px;">
          <strong>Location ${index + 1}:</strong><br>
          Lat: ${data.latitude.toFixed(6)}, Lng: ${data.longitude.toFixed(6)}<br>
          Accuracy: ${data.accuracy ? data.accuracy.toFixed(2) + 'm' : 'N/A'}<br>
          Time: ${new Date(data.timestamp).toLocaleString()}
        </div>
      `).join('');
      
      locationDisplay.innerHTML = dataHtml;
    }

    function clearStoredData() {
      // Clear localStorage
      localStorage.clear();
      
      // Clear IndexedDB
      if ('indexedDB' in window) {
        const deleteRequest = indexedDB.deleteDatabase('LocationTrackerDB');
        deleteRequest.onsuccess = () => {
          updateStatus('All stored location data cleared.', 'success');
          locationDisplay.textContent = 'No data available';
        };
        deleteRequest.onerror = () => {
          updateStatus('Failed to clear some data', 'warning');
        };
      } else {
        updateStatus('All stored location data cleared.', 'success');
        locationDisplay.textContent = 'No data available';
      }
    }

    // Event listeners
    startTrackingBtn.addEventListener('click', startBackgroundTracking);
    stopTrackingBtn.addEventListener('click', stopBackgroundTracking);
    getLocationBtn.addEventListener('click', getCurrentLocation);
    viewStoredBtn.addEventListener('click', viewStoredData);
    clearDataBtn.addEventListener('click', clearStoredData);

    // Initialize
    updateStatus('Initializing...', 'info');
    updateTrackingStatus(false);
    
    // Register Service Worker and initialize
    registerServiceWorker().then(() => {
      updateStatus('Ready to track location continuously', 'success');
    });
  </script>
</body>
</html>